<!DOCTYPE html>
<html>
<head>
    <title>Maps and Places Autocomplete</title>
    <script>
        let map, marker, infowindow, service;
        let selectedPlaces = []; // 선택된 장소 배열
        let markers = []; // 지도에 표시된 마커 배열

        async function init() {
            await customElements.whenDefined('gmp-map');

            map = document.querySelector('gmp-map');
            marker = document.querySelector('gmp-advanced-marker');
            infowindow = new google.maps.InfoWindow();
            service = new google.maps.places.PlacesService(map.innerMap);

            map.innerMap.setOptions({
                mapTypeControl: false
            });

            const placePicker = document.querySelector('gmpx-place-picker');
            placePicker.addEventListener('gmpx-placechange', () => {
                const place = placePicker.value;

                if (!place.location) {
                    window.alert("No details available for input: '" + place.name + "'");
                    infowindow.close();
                    marker.position = null;
                    return;
                }

                if (place.viewport) {
                    map.innerMap.fitBounds(place.viewport);
                } else {
                    map.center = place.location;
                    map.zoom = 17;
                }

                marker.position = place.location;
                infowindow.setContent(`<strong>${place.displayName}</strong><br><span>${place.formattedAddress}</span>`);
                infowindow.open(map.innerMap, marker);

                searchNearbyPlaces(place.location, 'tourist_attraction');
            });
        }

        function searchNearbyPlaces(location, placeType) {
            const request = {
                location: location,
                radius: '5000',
                type: [placeType],
                keyword: placeType === 'restaurant' ? '맛집' : '',
                language: 'ko' // 한국어로 설정
            };

            service.nearbySearch(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    results.sort((a, b) => (b.user_ratings_total || 0) - (a.user_ratings_total || 0));

                    const list = document.getElementById('places-list');
                    list.innerHTML = ''; // 이전 결과 지우기

                    results.forEach((result, index) => {
                        const li = document.createElement('li');
                        let placeImage = '';

                        if (result.photos && result.photos.length > 0) {
                            placeImage = `<img src="${result.photos[0].getUrl({maxWidth: 150, maxHeight: 150})}" alt="${result.name}">`;
                        }

                        li.innerHTML = `
                            ${placeImage}
                            <div class="place-details">
                                <strong>${result.name}</strong>
                                <span class="rating">리뷰 수: ${result.user_ratings_total || 0}</span>
                            </div>
                            <button class="add-btn" data-place-name="${result.name}" data-lat="${result.geometry.location.lat()}" data-lng="${result.geometry.location.lng()}">+</button>
                        `;

                        li.addEventListener('click', () => {
                            marker.position = result.geometry.location;
                            infowindow.setContent(`<strong>${result.name}</strong><br><span>${result.vicinity}</span>`);
                            infowindow.open(map.innerMap, marker);
                        });
                        list.appendChild(li);
                    });

                    // "+" 버튼 클릭 이벤트
                    document.querySelectorAll('.add-btn').forEach(button => {
                        button.addEventListener('click', function () {
                            const placeName = this.getAttribute('data-place-name');
                            const lat = parseFloat(this.getAttribute('data-lat'));
                            const lng = parseFloat(this.getAttribute('data-lng'));

                            if (!selectedPlaces.some(p => p.placeName === placeName)) {
                                selectedPlaces.push({ placeName, lat, lng });
                                updateSelectedPlaces();
                                updateMarkers();
                            }
                        });
                    });
                }
            });
        }

        function updateSelectedPlaces() {
            const selectedPlacesPanel = document.getElementById('selected-places');
            selectedPlacesPanel.innerHTML = ''; // 기존 패널 내용 초기화

            selectedPlaces.forEach((place, index) => {
                const div = document.createElement('div');
                div.classList.add('selected-place');
                div.innerHTML = `
                    <span>${index + 1}. ${place.placeName}</span>
                    <button class="remove-btn" data-index="${index}">X</button>
                `;
                selectedPlacesPanel.appendChild(div);
            });

            // 선택한 장소 패널에 "X" 버튼 클릭 시 삭제 이벤트
            document.querySelectorAll('.remove-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const index = parseInt(this.getAttribute('data-index'));
                    selectedPlaces.splice(index, 1); // 선택한 장소 배열에서 삭제
                    updateSelectedPlaces(); // 패널 업데이트
                    updateMarkers(); // 마커 업데이트
                });
            });
        }

        function updateMarkers() {
            // 모든 마커를 제거하고, 선택한 장소에 대해 마커 추가
            markers.forEach(marker => marker.setMap(null)); // 지도에서 모든 마커 제거
            markers = []; // 마커 배열 초기화

            selectedPlaces.forEach((place, index) => {
                const markerLabel = (index + 1).toString();
                const marker = new google.maps.Marker({
                    position: { lat: place.lat, lng: place.lng },
                    label: markerLabel,
                    map: map.innerMap
                });

                markers.push(marker); // 마커 배열에 추가

                marker.addListener('click', () => {
                    infowindow.setContent(`<strong>${place.placeName}</strong>`);
                    infowindow.open(map.innerMap, marker);
                });
            });
        }

        function resetSelectedPlaces() {
            selectedPlaces = [];
            updateSelectedPlaces();
            updateMarkers(); // 마커도 함께 지워짐
        }

        function changePlaceType(type) {
            const place = marker.position;
            if (!place) return;
            searchNearbyPlaces(place, type);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
    <script type="module" src="https://unpkg.com/@googlemaps/extended-component-library@0.6"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            font-family: Arial, sans-serif;
            display: flex;
        }

        #info-panel {
            width: 20%;
            background-color: #f5f5f5;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        #places-list, #selected-places {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
        }

        #places-list li, #selected-places li {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }

        #places-list img {
            margin-right: 10px;
            border-radius: 5px;
            width: 50px;
            height: 50px;
            object-fit: cover;
        }

        .place-details {
            display: flex;
            flex-direction: column;
            margin-right: auto;
        }

        .add-btn {
            padding: 5px 10px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .add-btn:hover {
            background-color: #0056b3;
        }

        .rating {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        gmp-map {
            width: 100%;
            height: 100%;
        }

        .place-picker-container {
            padding: 10px;
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            border-radius: 5px;
            width: 400px;
        }

        .category-buttons {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
        }

        .category-buttons button {
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .category-buttons .active {
            background-color: #007BFF;
            color: white;
        }

        .logout-button {
            background-color: #ff4d4d;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            margin-top: 20px;
            position: sticky;
            bottom: 0;
            width: 100%;
        }

        .logout-button:hover {
            background-color: #cc0000;
        }

        #selected-panel {
            width: 15%; /* 선택한 장소 패널 가로 크기 축소 */
            background-color: #f0f0f0;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .reset-button {
            margin-top: 20px;
            padding: 10px;
            background-color: #ff4d4d;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .reset-button:hover {
            background-color: #cc0000;
        }

        .remove-btn {
            padding: 5px;
            margin-left: auto;
            background-color: #ff4d4d;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }

        .remove-btn:hover {
            background-color: #cc0000;
        }

        .selected-place {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<div id="info-panel">
    <div class="place-picker-container">
        <gmpx-place-picker placeholder="주소를 입력하세요"></gmpx-place-picker>
    </div>

    <div class="category-buttons">
        <button class="active" onclick="changePlaceType('tourist_attraction')">추천 장소</button>
        <button onclick="changePlaceType('tourist_attraction')">관광지</button>
        <button onclick="changePlaceType('restaurant')">식당</button>
        <button onclick="changePlaceType('cafe')">카페</button>
    </div>

    <ul id="places-list"></ul>
    <button class="logout-button" onclick="window.location.href='/logout'">로그아웃</button>
</div>

<div id="selected-panel">
    <h3>선택한 장소</h3>
    <ul id="selected-places"></ul>
    <button class="reset-button" onclick="resetSelectedPlaces()">초기화</button>
</div>

<gmpx-api-loader key="AIzaSyBSrmV4v2IuA2pXwJ6x7IBg80zUEZAxMUc" solution-channel="GMP_GE_mapsandplacesautocomplete_v1">
</gmpx-api-loader>
<gmp-map center="40.749933,-73.98633" zoom="13" map-id="DEMO_MAP_ID">
    <gmp-advanced-marker></gmp-advanced-marker>
</gmp-map>
</body>
</html>
